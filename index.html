<!DOCTYPE html>
<html>
<head>
    <title>Discover Drive</title> 
  
    <script type="text/javascript">      
    var CLIENT_ID="1003542821097-ch60bub61oa3gq84p7gv3d90std7bq1j.apps.googleusercontent.com";
    var SCOPES=[
      'https://www.googleapis.com/auth/drive',
      'https://www.googleapis.com/auth/drive.file',
      'https://www.googleapis.com/auth/drive.appdata'
      ];
    
    var APPDATA_NAME = 'data.json';
    var APPDATA_META;
    var APPDATA;
    
    var GROUP="Group";
    var MEMBER="Member";
    var RESTAURANT="Restaurant";
    
    var GROUPS;
    var MEMBERS;
    var RESTAURANTS;
    var MEMU;

    var LABEL_WHEN = "일시";
    var LABEL_WHERE = "식당";
    var LABEL_WHAT = "메뉴";
    var LABEL_WHO_GROUP = "그룹";
    var LABEL_WHO_MEMBER = "멤버";
    
    
  
      function showContent() {
      var when = document.getElementById('when');
      when.innerHTML = "<lable onclick='addData(this)'>" + LABEL_WHEN + ": <input type='date' id='date' /></label>";
      when.innerHTML += "<input type='text' id='helpText'/>";
      document.getElementById('date').valueAsDate = new Date();        
      
      var where = document.getElementById('where');
      where.innerHTML += "<label onclick='addData(this)'>" + LABEL_WHERE + ": </lable>"; 
      var what = document.getElementById('what');     
            
      var who = document.getElementById('who');
      
      showRestaurant();           
      }
    
    function showRestaurant() {
    var where = document.getElementById('where');   
    for(var index in RESTAURANTS) {
      where.innerHTML += "<input type='button' value='" + RESTAURANTS[index] + "' id='" + RESTAURANTS[index] + "' onclick='showMenu(this.value)'>"; 
    }
      }
    
    function showMenu(restaurant) {
    var what = document.getElementById('what');
    var MENU = APPDATA[restaurant];
    what.innerHTML = "<label onclick='addData(this)'>" + LABLE_WHAT + ": </lable>";
    for(var key in MENU) {
      what.innerHTML += "<input type='button' value='" + key + " (" + MENU[key] + "원)' id='" + restaurant + "_" + key + "' onclick='setMenu(this.value)'>"; 
    }
      }
  
   function setMenu(menu) {
    var result = document.getElementById('result');   
    result.innerHTML += menu;
    showGroup();    
   }


      function showGroup() {
    var who = document.getElementById('who'); 
    who.innerHTML = "<label onclick='addData(this)'>" + LABLE_WHO_GROUP + ":</lable>";
    who.innerHTML += "<input type='button' value='All' id='all' onclick='showMember(this.value)'>";   
    for(var index in GROUPS) {
      who.innerHTML += "<input type='button' value='" + GROUPS[index] + "' id='" + GROUPS[index] + "' onclick='showMember(this.value)'>"; 
    }
      }
    
    function showMember(group) {
        var member = document.getElementById('member');   
        member.innerHTML = "<label onclick='addData(this)'>" + LABLE_WHO_MEMBER + ":</lable>";
    var memberArray;
    if("All" == group) {
      memberArray = MEMBERS;
    } else {
      memberArray = APPDATA[group];
    }   
    
        for(var index in memberArray) {
      member.innerHTML += "<input type='button' value='" + memberArray[index] + "' id='" + memberArray[index] + "'>"; 
    }
      }

      function addData(toggle) {
        var helpText = document.getElementById('helpText');        
        if(toggle.value == "+") {
          toggle.value = "-";  
          helpText.value = "add";
        } else {
          toggle.value = "+";  
          helpText.value = "remove";
        }
        
        //value.innerHTML += "<input type='text'>";

      }

    /**
    * Called when the client library is loaded.
    */  
    function handleClientLoad() {
      checkAuth();
    }
    
    function checkAuth() {
      gapi.auth.authorize(
        {'client_id': CLIENT_ID, 'scope' : SCOPES.join(' '), 'immediate': false}, 
        handleAuthResult
      );
    }

    function handleAuthResult(authResult) {
      if (authResult) {
        // Access token has been successfully retrieved, requests can be sent to the API
        executeWithDrive(getAppData);       
        //listFilesInApplicationDataFolder(checkApplicationDataFile);           
        //createApplicationDataFile();        
      } else {
        // No access token could be retrieved, force the authorization flow.
        gapi.auth.authorize(
          {'client_id': CLIENT_ID, 'scope': SCOPES, 'immediate': false},
          handleAuthResult);
      }
    }
    
    function executeWithDrive(callback) {     
      gapi.client.load('drive', 'v2', callback);
    }
      
    function getAppData() {     
      var request = gapi.client.drive.files.get({
        'fileId': 'appdata'
      });
      request.execute(function(resp) {
        APPDATA_META = resp;
        console.log(resp.title + ':' + APPDATA_META.id);    
        executeWithDrive(getDataFromAppData);               
      });     
    }
    
    function getDataFromAppData() {     
      var retrievePageOfFiles = function(request, result) {
        request.execute(function(resp) {
          result = result.concat(resp.items);
          var nextPageToken = resp.nextPageToken;
          if (nextPageToken) {
            request = gapi.client.drive.files.list({
              'pageToken': nextPageToken
            });
            retrievePageOfFiles(request, result);
          } else {
            checkData(result);
          }
        });
      }
      // var query = '\'appdata\' in parents and title = \'' + APPDATA_NAME + '\'';
      var query = 'title = \'aaa.aaa\'';
      var listRequest = gapi.client.drive.files.list({        
        'q': query        
        
      });
      retrievePageOfFiles(listRequest, []);     
    }
    
    function checkData(result) {
      var isFind = false;
      var item;
      for(var index in result) {
        item = result[index];
        if(typeof (item) != 'undefined') {          
          //if(item.title == APPDATA_NAME) {
            console.log('Data Exist');
            isFind = true;
            break;
          //}
        }
      }     
      
      if(isFind) {        
        executeWithDrive(getFileContent(item, function (response) {
          APPDATA = JSON.parse(response);
          for(var key in APPDATA) {   
      if(GROUP == key) {
        GROUPS = APPDATA[key];
      } else if(MEMBER == key) {
        MEMBERS = APPDATA[key];
      } else if(RESTAURANT == key) {
        RESTAURANTS = APPDATA[key];
      }
      
            console.log(key + ":" + APPDATA[key]);     
          }
      showContent();
        }));    
      } else {
        console.log('No Data File');
        var createData = function () {
          var metadata = {
            'title': 'data.json',
            'mimeType': 'application/json',
            'parents': [{
            'id': APPDATA_META.id
            }]
          };

          var request = gapi.client.request({
            'path': '/drive/v2/files',
            'method': 'POST',
            'params': {'uploadType': 'multipart'},
            'body': JSON.stringify(metadata)
          });
          
          request.execute(function(file) {
            console.log('Data Created');
            console.log(file);
          });
        }
        createData();
      }
    }

    function getFileContent(file, callback) {
      var url;
      if (file.downloadUrl) {
        url = file.downloadUrl;
      } else if (file.exportLinks){
        url = file['exportLinks']['text/plain'];
      }
url = 'https://docs.google.com/feeds/download/documents/export/Export?id=1q9-dUZ21i5xPLLBOHxPoteKhdpdtKEJKz6dxIF9peBs&exportFormat=txt';
      var accessToken = gapi.auth.getToken().access_token;
      var xhr = new XMLHttpRequest();
      xhr.open('GET', url);
      xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
      xhr.onload = function() {
        callback(xhr.responseText);
      };
      xhr.onerror = function() {
        
      };
      xhr.send();
    }

    function writeData(fileId, data) {  
      var content = new Array(data.length);
      for (var i = 0; i < content.length; i++) {
        content[i] = data.charCodeAt(i);
        console.log(ca[i]);
      }

      var byteArray = new Uint8Array(content);
      var blob = new Blob([byteArray], {type: 'text/plain'});
      var request = gapi.client.drive.files.get({'fileId': '1q9-dUZ21i5xPLLBOHxPoteKhdpdtKEJKz6dxIF9peBs'});
      request.execute(function(resp) {
        updateFile('1q9-dUZ21i5xPLLBOHxPoteKhdpdtKEJKz6dxIF9peBs', resp, blob, null);
      });
    }

    function updateFile(fileId, fileMetadata, blob,  callback) {
      const boundary = '-------314159265358979323846';
      const delimiter = "\r\n--" + boundary + "\r\n";
      const close_delim = "\r\n--" + boundary + "--";

      var reader = new FileReader();
      reader.readAsBinaryString(fileData);
      reader.onload = function(e) {
        var contentType = fileData.type || 'application/octet-stream';
        // Updating the metadata is optional and you can instead use the value from drive.files.get.
        var base64Data = btoa(reader.result);
        var multipartRequestBody =
            delimiter +
            'Content-Type: application/json\r\n\r\n' +
            JSON.stringify(fileMetadata) +
            delimiter +
            'Content-Type: ' + contentType + '\r\n' +
            'Content-Transfer-Encoding: base64\r\n' +
            '\r\n' +
            base64Data +
            close_delim;

        var request = gapi.client.request({
            'path': '/upload/drive/v2/files/' + id,
            'method': 'PUT',
            'params': {'uploadType': 'multipart', 'alt': 'json'},
            'headers': {
              'Content-Type': 'multipart/mixed; boundary="' + boundary + '"'
            },
            'body': multipartRequestBody});
        if (!callback) {
          callback = function(file) {
            console.log(file)
          };
        }
      request.execute(callback);
      }
    }
    
    function deleteFile(fileId) {
      var request = gapi.client.drive.files.delete({
        'fileId': fileId
      });
      request.execute(function(resp) { });
    }    
    //check file in AppData
    // if no, make new one.
  </script>
  <script src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>
</head>
<body>
<!--<div class="g-savetodrive" data-src="http://pagead2.googlesyndication.com/simgad/14610098017098633517" data-filename="test.jpg" data-sitename="testSite"></div>-->
<div id="when"></div>
<div id="where"></div>
<div id="what"></div>

<div id="who"></div>
<div id="member"></div>
<div id="result"></div>
</body>
</html>